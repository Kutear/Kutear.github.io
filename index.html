<!DOCTYPE html>
<html>
<head lang="zh">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
<meta content="telephone=no" name="format-detection"/>
<meta name="renderer" content="webkit">
<meta name="description" content="æ¸©æ•…è€ŒçŸ¥æ–°">
<meta http-equiv="Access-Control-Allow-Origin" content="*">

<title>KuTeat</title>
<link href="https://kutear.github.io/styles/main.css" type="text/css" rel="stylesheet"/>
<link rel="stylesheet" href="//cdn.bootcss.com/KaTeX/0.10.2/katex.min.css"/>
<script src="//cdn.bootcss.com/KaTeX/0.10.2/katex.min.js"></script>
<script src="//cdn.bootcss.com/KaTeX/0.10.2/contrib/auto-render.min.js"></script>
<script type="text/javascript" src="https://kutear.github.io/media/scripts/jquery.js"></script>
<script type="text/javascript" src="https://kutear.github.io/media/scripts/jquery.pjax.min.js"></script>
<script type="text/javascript" src="https://kutear.github.io/media/scripts/basic.js"></script>
<script type="text/javascript" src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script async type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script async type="text/javascript" src="https://kutear.github.io/media/scripts/search.js"></script>
<script type="text/javascript">
$(document).pjax('a[target!=_blank]', '#pjax-container', {
	fragment: '#pjax-container',
	timeout: 5000,
	cache: false
});
$(document).on('pjax:complete', function(){  	
	pjax();
});

$(window).on('popstate.pjax', function () {
	pjax();
})

function pjax() {
	$.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");

	if (("#gitalk-container").length > 0 ) {
	$('#mememe').attr('src','//source.unsplash.com/800x400/?arts,weather?'+Math.random());
	$.getScript("//cdn.bootcss.com/KaTeX/0.10.2/katex.min.js");
	$.getScript("//cdn.bootcss.com/KaTeX/0.10.2/contrib/auto-render.min.js");
	$('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
    	});
	}
}
</script>

  </head>

  <body>
    <div class="header">
      <div class="logo_title">
		  
        <div class="title animated fadeInDown"><img id="img1" style="display:inline-block;" src="https://kutear.github.io/images/avatar.png"/>
<script>
var r = 0;
    window.onload = function(){
        var current = 0;
        document.getElementById('img1').onclick = function(){
            current = (current+90)%360;
            this.style.transform = 'rotate('+current+'deg)';
        }
    };
</script>
          <h1 title="KuTeat" class="weaklink"><a  href="/">KuTeat</a>

          </h1>

          <div class="navbar weaklink">
            <div class="normal_nav">

<div class="bitcron_nav_container">


  <div class="bitcron_nav">
    <div class="mixed_site_nav_wrap site_nav_wrap">
		
      <ul class="mixed_site_nav site_nav sm sm-base">
	  
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a>
  </li>
  
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a>
  </li>
  
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a>
  </li>
  
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a>
  </li>
  
 
 <li>

      </ul>
	  

      <div class="clear clear_nav_inline_end"></div>
<div class="search">
    <i class="search-icon fa fa-search search-start"></i>
    <input type="text" class="search-input" placeholder="Searching..." />
    <i class="search-icon fa fa-refresh search-clear"></i>
	<div class="search-results"></div>
</div>
    </div>

  </div>



  <div class="clear clear_nav_end"></div>

</div>

            </div>
			
			<div class="hamberger"><i class="fa fa-bars"></i>
<i class="fa fa-times"></i>

			</div>

          </div>

        </div>

      </div>

      <div class="hidden_nav animated fadeInDown">

<div class="bitcron_nav_container">


  <div class="bitcron_nav">
    <div class="mixed_site_nav_wrap site_nav_wrap">
      <ul class="mixed_site_nav site_nav sm sm-base">
	
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a>

  </li>




      </ul>

      <div class="clear clear_nav_inline_end"></div>
    </div>

  </div>



  <div class="clear clear_nav_end"></div>

</div>

      </div>

    </div>

<style type="text/css">
.search {
    position: relative;
    height: 30px;
    text-align: right;
    line-height: 30px;
    padding-right: 10px;
}

.search .search-icon {
    float: right;
    height: 100%;
    margin: 0 10px;
    line-height: 30px;
    cursor: pointer;
    user-select: none;
}

.search .search-input {
    float: right;
    width: 30%;
    height: 30px;
    line-height: 30px;
    margin: 0;
    border: 2px solid #ddd;
    border-radius: 10px;
    box-sizing: border-box;
}

.search .search-clear {
    display: none;
}

.search .search-results {
    display: block;
    z-index: 1000;
    position: absolute;
    top: 30px;
    right: 50px;
    width: 50%;
    max-height: 400px;
    overflow: auto;
    text-align: left;
    border-radius: 5px;
    box-shadow: 0 .3rem .5rem #333;
}

.search .search-results .result-item {
    color: #000;
    margin: 5px;
    padding: 3px;
    border-radius: 3px;
    cursor: pointer;
}

</style>

    <div class="main" id="pjax-container">
      <div class="main-inner">

<div class="content">






  <div class="post_list" >

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2018-01-19-Android-Build-Instant_Run" >Instance Run åŸç†åˆ†æ</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2018-01-19-Android-Build-Instant_Run">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2018-01-19</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/GPgjH52Pi" class="tag">å¿«ç¼–</a>


	<a href="https://kutear.github.io/tag/cjJ_1EFpDV" class="tag">Instance Run</a>



</span>

<span>7 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-07-01-Android_Retrofit" >Retrofit åŸç†åˆ†æ</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-07-01-Android_Retrofit">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-07-01</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/SvZNQDrTBT" class="tag">Retrofit</a>


	<a href="https://kutear.github.io/tag/xNlEobg7Bc" class="tag">OkHttp</a>



</span>

<span>6 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-05-30-Android_Leakcanary" >LeakCanary åŸç†åˆ†æ</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-05-30-Android_Leakcanary">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-05-30</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/yjo-Qhu8H_" class="tag">LeakCanary</a>


	<a href="https://kutear.github.io/tag/o7M4f4U-RH" class="tag">å†…å­˜æ³„éœ²</a>



</span>

<span>5 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-04-21-Android_Volley" >æŠ›å¼€æºç è®²æµç¨‹-Volley</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-04-21-Android_Volley">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-04-21</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/WjwZNZu6nH" class="tag">Volley</a>


	<a href="https://kutear.github.io/tag/mmA5SnGI5e" class="tag">æºç åˆ†æ</a>



</span>

<span>4 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-04-20-Android_AsyncTask" >æŠ›å¼€æºç è®²æµç¨‹-AsyncTask</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-04-20-Android_AsyncTask">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-04-20</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/mmA5SnGI5e" class="tag">æºç åˆ†æ</a>


	<a href="https://kutear.github.io/tag/H7r8uDF7ao" class="tag">AsyncTask</a>



</span>

<span>2 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-04-19-Android_Handler" >æŠ›å¼€æºç è®²æµç¨‹-Handler</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-04-19-Android_Handler">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-04-19</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/mmA5SnGI5e" class="tag">æºç åˆ†æ</a>


	<a href="https://kutear.github.io/tag/x98QVmYRl6" class="tag">Handler</a>



</span>

<span>3 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-04-17-Android_Advanced" >AndroidçŸ¥è¯†ç‚¹æ€»ç»“</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-04-17-Android_Advanced">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-04-17</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/2bhUImQpoP" class="tag">Android</a>



</span>

<span>3 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-04-17-React_React-Native_Base" >Reactå’ŒReactNativeåŸºç¡€</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-04-17-React_React-Native_Base">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-04-17</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/MjYP1A4ov" class="tag">react</a>


	<a href="https://kutear.github.io/tag/bvSYFypAkg" class="tag">react native</a>



</span>

<span>2 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-04-13-Android_RecyclerView" >Android RecyclerViewä½¿ç”¨ä¸­çš„é—®é¢˜è®°å½•</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-04-13-Android_RecyclerView">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-04-13</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/2bhUImQpoP" class="tag">Android</a>



</span>

<span>2 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2017-02-15-Android_Apk_install" >Android Apkå®‰è£…è¿‡ç¨‹</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2017-02-15-Android_Apk_install">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2017-02-15</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/2bhUImQpoP" class="tag">Android</a>



</span>

<span>4 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-12-22-Go_Base_study" >GolangåŸºç¡€å­¦ä¹ </a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-12-22-Go_Base_study">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-12-22</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/HAcXtjRpl" class="tag">Golang</a>


	<a href="https://kutear.github.io/tag/g2V9K7uJS" class="tag">Activity</a>



</span>

<span>3 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-12-20-Android_Dev_Problem" >æœ€è¿‘å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-12-20-Android_Dev_Problem">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-12-20</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/jiDLpA7FR" class="tag">bug</a>



</span>

<span>2 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-11-15-Gradle_Share" >Gradleåˆ†äº«</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-11-15-Gradle_Share">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-11-15</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/rLx6fFtM0X" class="tag">Gradle</a>



</span>

<span>4 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-10-27-PMS-1" >PackageManagerServiceå­¦ä¹ --ä¸Š</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-10-27-PMS-1">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-10-27</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/A-hQFaIdbF" class="tag">PMS</a>



</span>

<span>36 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-10-09-Android_Xml_Parser" >Androidä¸­View,Drawable,Animationä»XMLä¸­è§£æç”Ÿæˆçš„è¿‡ç¨‹</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-10-09-Android_Xml_Parser">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-10-10</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	

</span>

<span>18 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-10-08-Android_Property_Animator" >Androidå±æ€§åŠ¨ç”»åŸç†</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-10-08-Android_Property_Animator">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-10-09</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	

</span>

<span>9 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-10-05-Android_Animation_Principle" >Android ViewåŠ¨ç”»å®ç°ç»˜åˆ¶åŸç†</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-10-05-Android_Animation_Principle">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-10-05</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	

</span>

<span>12 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-09-20-Android-Windows" >å¯¹Window/WindowManagerå’ŒWindowManagerSystemçš„ç†è§£</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p><h1 id="windowsmanager">WindowsManager</h1>
<h2 id="windowçš„type">Windowçš„type</h2>
<blockquote>
<p>The general type of window.  There are three main classes of<br>
window types:</p>
</blockquote>
  <ul>
  <li> <strong>Application windows</strong> (ranging from
  {@link #FIRST_APPLICATION_WINDOW} to
  {@link #LAST_APPLICATION_WINDOW}) are normal top-level application
  windows.  For these types of windows, the {@link #token} must be
  set to the token of the activity they are a part of (this will
  normally be done for you if {@link #token} is null).
  <li> <strong>Sub-windows</strong> (ranging from
  {@link #FIRST_SUB_WINDOW} to
  {@link #LAST_SUB_WINDOW}) are associated with another top-level
  window.  For these types of windows, the {@link #token} must be
  the token of the window it is attached to.
  <li> <strong>System windows</strong> (ranging from
  {@link #FIRST_SYSTEM_WINDOW} to
  {@link #LAST_SYSTEM_WINDOW}) are special types of windows for
  use by the system for specific purposes.  They should not normally
  be used by applications, and a special permission is required
  to use them.
  </ul>
                           		---WindowManager.java
<p>ä»¥ä¸Šæ¥æº<a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/core/java/android/view/WindowManager.java#199">WindowManager#LayoutParams</a>ï¼Œä»‹ç»äº†Windowåˆ†ä¸º<code>Application windows</code>ï¼Œ<code>Sub-windows</code>ï¼Œ<code>System windows</code>ä¸‰ç§ã€‚</p>
<h2 id="getsystemservicestrçš„å®ç°åŸç†">getSystemService(str)çš„å®ç°åŸç†</h2>
<p>æˆ‘ä»¬çŸ¥é“<code>Context</code>çš„å®ç°ç±»æ˜¯<code>ContextImpl</code>ï¼Œé€šè¿‡æŸ¥çœ‹æºç ï¼Œå¾—åˆ°å‡½æ•°çš„å®ç°ä¸º<a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/app/ContextImpl.java#1538">æºç </a>ã€‚</p>
<pre><code class="language-java">    //ContextImpl.java
    @Override
    public Object getSystemService(String name) {
        return SystemServiceRegistry.getSystemService(this, name);
    }
</code></pre>
<p>OK,åœ¨æ­¤å¯ä»¥çœ‹è§ï¼Œæ˜¯è°ƒç”¨<code>SystemServiceRegistry</code>çš„é™æ€å‡½æ•°<code>getSystemService(..)</code>æ¥å®ç°çš„ï¼Œæˆ‘ä»¬è·Ÿç€æ·±å…¥ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°ä¸º<a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/app/SystemServiceRegistry.java#790">æºç </a></p>
<pre><code class="language-java">    //SystemServiceRegistry.java
    /**
     * Gets a system service from a given context.
     */
    public static Object getSystemService(ContextImpl ctx, String name) {
        ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);
        return fetcher != null ? fetcher.getService(ctx) : null;
    }
</code></pre>
<p>OKï¼Œè¿›ä¸€æ­¥çŸ¥é“æ˜¯ä»<code>ServiceFetcher</code>ä¸­è·å–åˆ°çš„ï¼Œè€Œ<code>ServiceFetcher</code>æ˜¯ä»<code>SYSTEM_SERVICE_FETCHERS</code>è·å–åˆ°çš„ï¼Œè·Ÿè¿›çŸ¥é“<code>SYSTEM_SERVICE_FETCHERS</code>çš„ç”³æ˜ä¸º</p>
<pre><code class="language-java">    private static final HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS =
            new HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt;();
</code></pre>
<p>æ˜¯ä¸ª<code>HashMap</code>ï¼Œç°åœ¨æˆ‘ä»¬å°±è¦çœ‹çœ‹æ•°æ®æ˜¯åœ¨å“ªé‡Œ<code>put</code>è¿›å»çš„ï¼Œé€šè¿‡åˆ†ææŸ¥æ‰¾ï¼Œ<code>put</code>åªåœ¨å‡½æ•°<code>registerService()</code>ä¸­è°ƒç”¨è¿‡ï¼Œæ‰€ä»¥è¿™äº›æœåŠ¡ä¸€å®šæ˜¯é€šè¿‡è¿™é‡Œæ³¨å†Œçš„ã€‚ç”±äºæ˜¯<code>static final</code>ï¼Œæ‰€ä»¥åªèƒ½åœ¨æ„é€ å‡½æ•°æˆ–é™æ€å—è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™å°±å¾ˆæ–¹ä¾¿æˆ‘ä»¬æŸ¥æ‰¾ã€‚æ ¹æ®æŸ¥æ‰¾ï¼Œå¯çœ‹è§å®ç°<a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/app/SystemServiceRegistry.java#151">æºç </a>ã€‚</p>
<pre><code class="language-java">	static {
        registerService(Context.ACCESSIBILITY_SERVICE, AccessibilityManager.class,
                new CachedServiceFetcher&lt;AccessibilityManager&gt;() {
            @Override
            public AccessibilityManager createService(ContextImpl ctx) {
                return AccessibilityManager.getInstance(ctx);
        }});
        ......
        registerService(Context.WINDOW_SERVICE, WindowManager.class,
               new CachedServiceFetcher&lt;WindowManager&gt;() {
            @Override
            public WindowManager createService(ContextImpl ctx) {
                return new WindowManagerImpl(ctx);
        }});
        ......
	}
    /**
     * Statically registers a system service with the context.
     * This method must be called during static initialization only.
     */
    private static &lt;T&gt; void registerService(String serviceName, Class&lt;T&gt; serviceClass,
            ServiceFetcher&lt;T&gt; serviceFetcher) {
        SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);
        SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);
    }
</code></pre>
<p>å›åˆ°ä¸Šé¢çš„<code>fetcher.getService(ctx)</code>å‡½æ•°ï¼Œå®ƒçš„å®ç°ä¸º<a href="https://android.googlesource.com/platform/frameworks/base/+/d0c83cc/core/java/android/app/ContextImpl.java#212">æºç </a>ã€‚</p>
<pre><code class="language-java">    //ä»£ç å»é™¤äº†æ— ç”¨éƒ¨åˆ†
	public Object getService(ContextImpl ctx) {
        service = createService(ctx);
        cache.set(mContextCacheIndex, service);
        return service;
</code></pre>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çŸ¥é“å¹³æ—¶ä½¿ç”¨<code>WindowManager</code>çš„çœŸå®å¯¹è±¡å…¶å®æ˜¯<code>WindowManagerImpl</code>ã€‚</p>
<h2 id="windowçš„æ·»åŠ è¿‡ç¨‹">Windowçš„æ·»åŠ è¿‡ç¨‹</h2>
<p>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼ŒçŸ¥é“äº†<code>WindowManagerImpl</code>æ‰æ˜¯å¹•åçš„å‡¶æ‰‹ï¼Œä½†æ˜¯çœŸçš„æ˜¯è¿™æ ·çš„å—ï¼Ÿæˆ‘ä»¬æ¥ç€åˆ†æã€‚åœ¨å®ƒçš„æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹<a href="https://android.googlesource.com/platform/frameworks/base/+/0e2d281/core/java/android/view/WindowManagerImpl.java">æºç </a></p>
<pre><code class="language-java">public final class WindowManagerImpl implements WindowManager {
    private final WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();
    private final Display mDisplay;
    private final Window mParentWindow;
    public WindowManagerImpl(Display display) {
        this(display, null);
    }
    private WindowManagerImpl(Display display, Window parentWindow) {
        mDisplay = display;
        mParentWindow = parentWindow;
    }
    public WindowManagerImpl createLocalWindowManager(Window parentWindow) {
        return new WindowManagerImpl(mDisplay, parentWindow);
    }
    public WindowManagerImpl createPresentationWindowManager(Display display) {
        return new WindowManagerImpl(display, mParentWindow);
    }
    @Override
    public void addView(View view, ViewGroup.LayoutParams params) {
        mGlobal.addView(view, params, mDisplay, mParentWindow);
    }
    @Override
    public void updateViewLayout(View view, ViewGroup.LayoutParams params) {
        mGlobal.updateViewLayout(view, params);
    }
    @Override
    public void removeView(View view) {
        mGlobal.removeView(view, false);
    }
    @Override
    public void removeViewImmediate(View view) {
        mGlobal.removeView(view, true);
    }
    @Override
    public Display getDefaultDisplay() {
        return mDisplay;
    }
}
</code></pre>
<p>å§æ§½ï¼Œæ·»åŠ <code>View</code>å¹¶ä¸æ˜¯å®ƒåœ¨æ“ä½œï¼Œçœ‹æ¥çœŸå®å¦æœ‰éšæƒ…å•Šã€‚<code>Window</code>çš„ä¸‰å¤§æ“ä½œ(add,remove,update)éƒ½æ˜¯æœ‰<code>WindowManagerGlobal</code>æ¥å®ç°çš„ã€‚ä¸‹é¢åˆ†æ<code>WindowManagerGlobal</code>,å…ˆçœ‹çœ‹å®ƒçš„å†…éƒ¨å­—æ®µçš„å«ä¹‰ã€‚</p>
<pre><code class="language-java">//å­˜å‚¨æ‰€æœ‰Windowå¯¹åº”çš„View
private final ArrayList&lt;View&gt; mViews = new ArrayList&lt;View&gt;();
//å­˜å‚¨æ‰€æœ‰Windowå¯¹åº”çš„ViewRootImpl
private final ArrayList&lt;ViewRootImpl&gt; mRoots = new ArrayList&lt;ViewRootImpl&gt;();
//å­˜å‚¨æ‰€æœ‰Windowå¯¹åº”çš„å¸ƒå±€å‚æ•°
private final ArrayList&lt;WindowManager.LayoutParams&gt; mParams =
        new ArrayList&lt;WindowManager.LayoutParams&gt;();
//å­˜å‚¨æ­£åœ¨è¢«åˆ é™¤çš„View(å·²ç»è°ƒç”¨removeä½†removeè¿˜æ²¡æœ‰å®Œæˆ)
private final ArraySet&lt;View&gt; mDyingViews = new ArraySet&lt;View&gt;();
</code></pre>
<p>æ¥ä¸‹æ¥å°±æ˜¯æ ¸å¿ƒéƒ¨åˆ†äº†ï¼Œåˆ†æ<code>addView</code>çš„<a href="https://android.googlesource.com/platform/frameworks/base/+/0e40462e11d27eb859b829b112cecb8c6f0d7afb/core/java/android/view/WindowManagerGlobal.java#204">æºç </a>ã€‚</p>
<pre><code class="language-java">public void addView(View view, ViewGroup.LayoutParams params,
        Display display, Window parentWindow) {
    ...... å‚æ•°åˆæ³•åˆ¤æ–­
    final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams)params;
    if (parentWindow != null) {
        //parentWindow != null è¡¨ç¤ºæ–°å»ºçš„Windowçš„typeä¸ºå­Window,å¦‚Dialog,å…¶ä¸»è¦ä½œç”¨æ˜¯ä¿®æ”¹token
        //å­Windowå›å…±ç”¨çˆ¶Windowçš„token.
        parentWindow.adjustLayoutParamsForSubWindow(wparams);
    } else {
        // If there's no parent and we're running on L or above (or in the
        // system context), assume we want hardware acceleration.
        final Context context = view.getContext();
        if (context != null
                &amp;&amp; context.getApplicationInfo().targetSdkVersion &gt;= Build.VERSION_CODES.LOLLIPOP) {
            wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;
        }
    }
    ViewRootImpl root;
    View panelParentView = null;
    synchronized (mLock) {
        // Start watching for system property changes.
        if (mSystemPropertyUpdater == null) {
            mSystemPropertyUpdater = new Runnable() {
                @Override public void run() {
                    synchronized (mLock) {
                        for (int i = mRoots.size() - 1; i &gt;= 0; --i) {
                            mRoots.get(i).loadSystemProperties();
                        }
                    }
                }
            };
            SystemProperties.addChangeCallback(mSystemPropertyUpdater);
        }
        //viewåœ¨mViewsä¸­çš„ä½ç½®
        int index = findViewLocked(view, false);
        //æ‰¾åˆ°è¯´æ˜è¯¥Viewå·²ç»æ·»åŠ åˆ°æŸä¸ªWindow
        if (index &gt;= 0) {
            //æ­£åœ¨remove
            if (mDyingViews.contains(view)) {
                // Don't wait for MSG_DIE to make it's way through root's queue.
                mRoots.get(index).doDie();
            } else {
                throw new IllegalStateException(&quot;View &quot; + view
                        + &quot; has already been added to the window manager.&quot;);
            }
            // The previous removeView() had not completed executing. Now it has.
        }
        // If this is a panel window, then find the window it is being
        // attached to for future reference.
        if (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;
                wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) {
            final int count = mViews.size();
            for (int i = 0; i &lt; count; i++) {
                if (mRoots.get(i).mWindow.asBinder() == wparams.token) {
                    panelParentView = mViews.get(i);
                }
            }
        }
        root = new ViewRootImpl(view.getContext(), display);
        view.setLayoutParams(wparams);
        mViews.add(view);
        mRoots.add(root);
        mParams.add(wparams);
    }
    // do this last because it fires off messages to start doing things
    try {
        root.setView(view, wparams, panelParentView);
    } catch (RuntimeException e) {
        // BadTokenException or InvalidDisplayException, clean up.
        synchronized (mLock) {
            final int index = findViewLocked(view, false);
            if (index &gt;= 0) {
                removeViewLocked(index, true);
            }
        }
        throw e;
    }
}
</code></pre>
<p>çœ‹äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬å‘ç°è¿˜æ˜¯æ²¡æœ‰çœ‹è§æ ¸å¿ƒä»£ç ï¼Œé‚£å°±ç»§ç»­å¾€ä¸‹çœ‹å’¯ï¼Œ<code>ViewRootImpl</code>è¿™ä¸ªç±»ã€‚<code>ViewRootImpl</code>æ˜¯<code>FrameWork</code>å±‚ä¸<code>Native</code>å±‚çš„é€šä¿¡æ¡¥æ¢ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­æœ‰å®ä¾‹åŒ–å®ƒ,æˆ‘ä»¬çœ‹çœ‹å…·ä½“çš„å®ç°.</p>
<pre><code class="language-java">public ViewRootImpl(Context context, Displaydisplay) {
    // â‘  ä»WindowManagerGlobalä¸­è·å–ä¸€ä¸ªIWindowSessionçš„å®ä¾‹ã€‚å®ƒæ˜¯ViewRootImplå’ŒWMSè¿›è¡Œé€šä¿¡çš„ä»£ç†
   mWindowSession= WindowManagerGlobal.getWindowSession(context.getMainLooper());
    // â‘¡ ä¿å­˜å‚æ•°displayï¼Œåœ¨åé¢setView()è°ƒç”¨ä¸­å°†ä¼šæŠŠçª—å£æ·»åŠ åˆ°è¿™ä¸ªDisplayä¸Š
   mDisplay= display;
   CompatibilityInfoHolder cih = display.getCompatibilityInfo();
   mCompatibilityInfo = cih != null ? cih : new CompatibilityInfoHolder();
    // â‘¢ ä¿å­˜å½“å‰çº¿ç¨‹åˆ°mThreadã€‚è¿™ä¸ªèµ‹å€¼æ“ä½œä½“ç°äº†åˆ›å»ºViewRootImplçš„çº¿ç¨‹å¦‚ä½•æˆä¸ºUIä¸»çº¿ç¨‹ã€‚åœ¨ViewRootImplå¤„ç†æ¥è‡ªæ§ä»¶æ ‘çš„è¯·æ±‚æ—¶ï¼ˆå¦‚è¯·æ±‚é‡æ–°å¸ƒå±€ï¼Œè¯·æ±‚é‡ç»˜ï¼Œæ”¹å˜ç„¦ç‚¹ç­‰ï¼‰ï¼Œä¼šæ£€æŸ¥å‘èµ·è¯·æ±‚çš„threadä¸è¿™ä¸ªmThreadæ˜¯å¦ç›¸åŒã€‚å€˜è‹¥ä¸åŒåˆ™ä¼šæ‹’ç»è¿™ä¸ªè¯·æ±‚å¹¶æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸
    mThread= Thread.currentThread();
    ......
    // â‘£ mDirtyç”¨äºæ”¶é›†çª—å£ä¸­çš„æ— æ•ˆåŒºåŸŸã€‚**æ‰€è°“æ— æ•ˆåŒºåŸŸæ˜¯æŒ‡ç”±äºæ•°æ®æˆ–çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶è€Œéœ€è¦è¿›è¡Œé‡ç»˜çš„åŒºåŸŸã€‚ä¸¾ä¾‹è¯´æ˜ï¼Œå½“åº”ç”¨ç¨‹åºä¿®æ”¹äº†ä¸€TextViewçš„æ–‡å­—æ—¶ï¼ŒTextViewä¼šå°†è‡ªå·±çš„åŒºåŸŸæ ‡è®°ä¸ºæ— æ•ˆåŒºåŸŸï¼Œå¹¶é€šinvalidate()æ–¹æ³•å°†è¿™å—åŒºåŸŸæ”¶é›†åˆ°è¿™é‡Œçš„mDirtyä¸­ã€‚å½“ä¸‹æ¬¡ç»˜åˆ¶æ—¶ï¼ŒTextViewä¾¿å¯ä»¥å°†æ–°çš„æ–‡å­—ç»˜åˆ¶åœ¨è¿™å—åŒºåŸŸä¸Š
    mDirty =new Rect();
    mTempRect = new Rect();
    mVisRect= new Rect();
    // â‘¤ mWinFrameï¼Œæè¿°äº†å½“å‰çª—å£çš„ä½ç½®å’Œå°ºå¯¸ã€‚ä¸WMSä¸­WindowState.mFrameä¿æŒç€ä¸€è‡´
    mWinFrame = new Rect();
    // â‘¥ åˆ›å»ºä¸€ä¸ªWç±»å‹çš„å®ä¾‹ï¼ŒWæ˜¯IWindow.Stubçš„å­ç±»ã€‚å³å®ƒå°†åœ¨WMSä¸­ä½œä¸ºæ–°çª—å£çš„IDï¼Œä»¥åŠæ¥æ”¶æ¥è‡ªWMSçš„å›è°ƒ
    mWindow= new W(this);
    ......
    // â‘¦ åˆ›å»ºmAttachInfoã€‚mAttachInfoæ˜¯æ§ä»¶ç³»ç»Ÿä¸­å¾ˆé‡è¦çš„å¯¹è±¡ã€‚å®ƒå­˜å‚¨äº†æ­¤å½“å‰æ§ä»¶æ ‘æ‰€ä»¥è´´é™„çš„çª—å£çš„å„ç§æœ‰ç”¨çš„ä¿¡æ¯ï¼Œå¹¶ä¸”ä¼šæ´¾å‘ç»™æ§ä»¶æ ‘ä¸­çš„æ¯ä¸€ä¸ªæ§ä»¶ã€‚è¿™äº›æ§ä»¶ä¼šå°†è¿™ä¸ªå¯¹è±¡ä¿å­˜åœ¨è‡ªå·±çš„mAttachInfoå˜é‡ä¸­ã€‚mAttachInfoä¸­æ‰€ä¿å­˜çš„ä¿¡æ¯æœ‰WindowSessionï¼Œçª—å£çš„å®ä¾‹ï¼ˆå³mWindowï¼‰ï¼Œ ViewRootImplå®ä¾‹ï¼Œçª—å£æ‰€å±çš„Displayï¼Œçª—å£çš„Surfaceä»¥åŠçª—å£åœ¨å±å¹•ä¸Šçš„ä½ç½®ç­‰ç­‰ã€‚æ‰€ä»¥ï¼Œå½“è¦éœ€åœ¨ä¸€ä¸ªViewä¸­æŸ¥è¯¢ä¸å½“å‰çª—å£ç›¸å…³çš„ä¿¡æ¯æ—¶ï¼Œéå¸¸å€¼å¾—åœ¨mAttachInfoä¸­æœç´¢ä¸€ä¸‹
    mAttachInfo = new View.AttachInfo(mWindowSession, mWindow, display,this, mHandler, this);
    // â‘§ åˆ›å»ºFallbackEventHandlerã€‚**è¿™ä¸ªç±»å¦‚åŒPhoneWindowMangerä¸€æ ·å®šä¹‰åœ¨android.policyåŒ…ä¸­ï¼Œå…¶å®ç°ä¸ºPhoneFallbackEventHandlerã€‚FallbackEventHandleræ˜¯ä¸€ä¸ªå¤„ç†æœªç»ä»»ä½•äººæ¶ˆè´¹çš„è¾“å…¥äº‹ä»¶çš„åœºæ‰€ã€‚åœ¨6.5.4èŠ‚ä¸­å°†ä¼šä»‹ç»å®ƒ
    mFallbackEventHandler =PolicyManager.makeNewFallbackEventHandler(context);
    ......
    //â‘¨ åˆ›å»ºä¸€ä¸ªä¾é™„äºå½“å‰çº¿ç¨‹ï¼Œå³ä¸»çº¿ç¨‹çš„Choreographerï¼Œç”¨äºé€šè¿‡VSYNCç‰¹æ€§å®‰æ’é‡ç»˜è¡Œä¸º
    mChoreographer= Choreographer.getInstance();
    ......
}
</code></pre>
<p>ä»¥ä¸Šåˆ†ææ¥æºäº<a href="https://wizardforcel.gitbooks.io/deepin-android-vol3/content/6.html">GITBOOK</a>.æ¥ç€çœ‹çœ‹<code>mWindowSession</code>æ˜¯æ€ä¹ˆæ¥çš„ã€‚</p>
<pre><code class="language-java">public static IWindowSession getWindowSession() {
     //ä»£ç åˆ é™¤å¹²æ‰°éƒ¨åˆ†
     InputMethodManager imm = InputMethodManager.getInstance();
     IWindowManager windowManager = getWindowManagerService();
     sWindowSession = windowManager.openSession(
             new IWindowSessionCallback.Stub() {
                   @Override
                   public void onAnimatorScaleChanged(float scale) {
                          ValueAnimator.setDurationScale(scale);
                   }
             },
             imm.getClient(),
             imm.getInputContext());
     return sWindowSession;
}
</code></pre>
<p>é€šè¿‡Googleæœç´¢ï¼Œæˆ‘ä»¬å‘ç°<code>IWindowManager</code>å…¶å®æ˜¯ä¸€ä¸ª<code>AIDL</code>æ–‡ä»¶,<a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/view/IWindowManager.aidl">ä»£ç åœ¨æ­¤</a>,ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œçš„å®ç°å…¶å®æ˜¯è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œç»§ç»­è·Ÿè¿›ä¸‹<code>getWindowManagerService()</code>çš„å®ç°ã€‚</p>
<pre><code class="language-java">public static IWindowManager getWindowManagerService() {
        synchronized (WindowManagerGlobal.class) {
            if (sWindowManagerService == null) {
                sWindowManagerService = IWindowManager.Stub.asInterface(
                        ServiceManager.getService(&quot;window&quot;));
                ......        
            }
            return sWindowManagerService;
        }
    }
</code></pre>
<p>æ ¹æ®æˆ‘ä»¬å·²æœ‰çš„AIDLçš„çŸ¥è¯†ï¼Œæˆ‘ä»¬çŸ¥é“<code>ServiceManager.getService(&quot;window&quot;)</code>è¿”å›çš„å…¶å®æ˜¯ä¸€ä¸ª<code>IBinder</code>,è¿™é‡Œæ¥ç€çœ‹çœ‹åˆ°åº•è¿”å›çš„æ˜¯ä»€ä¹ˆï¼Ÿ<a href="https://android.googlesource.com/platform/frameworks/base/+/0e2d281/core/java/android/os/ServiceManager.java#49">åœ¨æºç ä¸­</a>æŸ¥çœ‹ã€‚</p>
<pre><code class="language-java">public static IBinder getService(String name) {
     ...
     return getIServiceManager().getService(name);
     ...
}
public static void addService(String name, IBinder service) {
    getIServiceManager().addService(name, service, false);
}
</code></pre>
<p>æ‰€ä»¥ï¼Œæ‰€æœ‰çš„æœåŠ¡éƒ½æ˜¯é€šè¿‡<code>addService</code>æ·»åŠ åˆ°<code>ServiceManager</code>,ç„¶åé€šè¿‡<code>getService</code>å–å‡ºï¼Œä½†æ˜¯æ˜¯æ€ä¹ˆæ·»åŠ ï¼Œæ¯ä¸ªæœåŠ¡å…·ä½“çš„ç±»æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬åªè¦çœ‹çœ‹å“ªé‡Œè°ƒç”¨<code>addService</code>å³å¯ã€‚<a href="https://android.googlesource.com/platform/frameworks/base.git/+/22f7dfd23490a3de2f21ff96949ba47003aac8f8/services/java/com/android/server/SystemServer.java#97">æºç </a></p>
<pre><code class="language-java">try {
  power = new PowerManagerService();
  ServiceManager.addService(Context.POWER_SERVICE, power);
  ....
  wm = WindowManagerService.main(context, power,
                   factoryTest != SystemServer.FACTORY_TEST_LOW_LEVEL);
  ServiceManager.addService(Context.WINDOW_SERVICE, wm);//Context.WINDOW_SERVICE = &quot;window&quot;
}
...
</code></pre>
<p>åœ¨<code>WindowManagerService.main(...)</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿”å›çš„å…¶å®æ˜¯	<code>WindowManagerService</code>ã€‚è€Œ<code>WindowManagerService</code>çš„å£°æ˜ä¸º</p>
<pre><code class="language-java">public class WindowManagerService extends IWindowManager.Stub
        implements Watchdog.Monitor, WindowManagerPolicy.WindowManagerFuncs{}

class IWindowManager.Stub extends android.os.Binder{}

public class Binder implements IBinder{}
</code></pre>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°,è¿™æ˜¯å¾ˆæ™®é€šçš„ä¸€ä¸ªAIDLçš„å®ç°.å›åˆ°å‡½æ•°<code>getWindowSession()</code>,</p>
<pre><code class="language-java">IWindowManager windowManager = getWindowManagerService();
sWindowSession = windowManager.openSession(
        new IWindowSessionCallback.Stub() {
              @Override
              public void onAnimatorScaleChanged(float scale) {
                     ValueAnimator.setDurationScale(scale);
              }
        },
        imm.getClient(),
        imm.getInputContext());
</code></pre>
<p>æˆ‘ä»¬çŸ¥é“äº†<code>windowManager</code>å…¶å®æ˜¯<code>WindowManagerService</code>,æ‰€ä»¥çœ‹çœ‹<code>openSession</code>çš„å…·ä½“å®ç°ã€‚</p>
<pre><code class="language-java">@Override
public IWindowSession openSession(IWindowSessionCallback callback, IInputMethodClient client,IInputContext inputContext) {
    if (client == null) throw new IllegalArgumentException(&quot;null client&quot;);
    if (inputContext == null) throw new IllegalArgumentException(&quot;null inputContext&quot;);
    Session session = new Session(this, callback, client, inputContext);
    return session;
}
</code></pre>
<p>å¯ä»¥çœ‹è§<code>Session</code>çš„ç­¾åå¦‚ä¸‹,æˆ‘ä»¬çŸ¥é“å®ƒæ˜¯<code>IWindowSession.aidl</code>çš„å…·ä½“å®ç°.</p>
<pre><code class="language-java">final class Session extends IWindowSession.Stub
        implements IBinder.DeathRecipient{}
</code></pre>
<blockquote>
<p>This class represents an active client session.  There is generally one<br>
Session object per process that is interacting with the window manager.</p>
</blockquote>
<p><code>WindowManagerGlobal</code>çš„<code>addView()</code>æœ€ç»ˆè°ƒç”¨çš„äº†<code>ViewRootImpl</code>çš„<code>setView()</code>æ–¹æ³•,é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åˆæ˜¯åšä»€ä¹ˆç”¨çš„?</p>
<pre><code class="language-java">// Schedule the first layout -before- adding to the window
// manager, to make sure we do the relayout before receiving
// any other events from the system.
requestLayout();
...
try {
    ...
    res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,
            getHostVisibility(), mDisplay.getDisplayId(),
            mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,
            mAttachInfo.mOutsets, mInputChannel);
} catch (RemoteException e) {} finally {}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­çš„<code>requestLayout()</code>ä¼šè°ƒç”¨<code>scheduleTraversals()</code>æ–¹æ³•,è€Œè¯¥æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨<code>performTraversals()</code>,è¯¥å‡½æ•°å°±æ˜¯androidç³»ç»ŸViewæ ‘éå†å·¥ä½œçš„æ ¸å¿ƒã€‚æ‰§è¡Œè¿‡ç¨‹å¯ç®€å•æ¦‚æ‹¬ä¸ºæ ¹æ®ä¹‹å‰æ‰€æœ‰è®¾ç½®å¥½çš„çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è®¡ç®—è§†å›¾å¤§å°ï¼ˆmeasureï¼‰ã€æ˜¯å¦éœ€è¦é‡æ–°å®‰ç½®è§†å›¾çš„ä½ç½®ï¼ˆlayoutï¼‰ï¼Œä»¥åŠæ˜¯å¦éœ€è¦é‡ç»˜ï¼ˆdrawï¼‰è§†å›¾,è¿™é‡Œæˆ‘ä¸ä¼šè¿›ä¸€æ­¥åˆ†æ.ä¸‹é¢çœ‹çœ‹<code>mWindowSession.addToDisplay()</code>çš„è°ƒç”¨,æˆ‘ä»¬çŸ¥é“<code>mWindowSession</code>å°±æ˜¯<code>Session</code>,è¿™ä¸ªå‡½æ•°çš„å®ç°ä¸º</p>
<pre><code class="language-java">@Override
public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs,
        int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets,
        Rect outOutsets, InputChannel outInputChannel) {
          //mService æ˜¯WindowManagerService ,æ„é€ å‡½æ•°ä¸­èµ‹çš„å€¼
    return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId,
            outContentInsets, outStableInsets, outOutsets, outInputChannel);
}
</code></pre>
<p>å¯ä»¥çœ‹å‡ºï¼ŒWindowçš„æ·»åŠ è¯·æ±‚å°±äº¤ç»™WindowManagerServiceå»å¤„ç†äº†ã€‚addViewå¤§æ¦‚ä¸€ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>WindowManagerImplâ€”â€”&gt;WindowManagerGobalâ€”â€”&gt;ViewRootImplâ€”â€”&gt;Sessionâ€”â€”&gt;WindowManagerService</p>
</blockquote>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://wizardforcel.gitbooks.io/deepin-android-vol3/content/6.html">æ·±å…¥ç†è§£æ§ä»¶ï¼ˆViewRootï¼‰ç³»ç»Ÿ</a></li>
<li><a href="http://blog.csdn.net/qianhaifeng2012/article/details/51737370">Androidä¸­çš„ViewRootImplç±»æºç è§£æ</a></li>
</ul>
</p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-09-20-Android-Windows">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-09-20</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/23BKTXLtA" class="tag">View</a>


	<a href="https://kutear.github.io/tag/w-_t1J-CXe" class="tag">Touch</a>



</span>

<span>13 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-09-12-View_Touch_Event_1" >ViewGroupäº‹ä»¶åˆ†å‘1</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-09-12-View_Touch_Event_1">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-09-12</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/23BKTXLtA" class="tag">View</a>


	<a href="https://kutear.github.io/tag/w-_t1J-CXe" class="tag">Touch</a>



</span>

<span>10 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-08-30-SparseArray" >SparseArray åŸç†åˆ†æ</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-08-30-SparseArray">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-08-30</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/3U8EE2nyp" class="tag">SparseArray</a>


	<a href="https://kutear.github.io/tag/2bhUImQpoP" class="tag">Android</a>



</span>

<span>4 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-08-22-EventBus" >EventBusæºç åˆ†æ</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-08-22-EventBus">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-08-22</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/m8i70eBHPt" class="tag">Thinking In Java</a>



</span>

<span>16 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-07-28_Android_WebView_Comication_With_Js" >Android WebViewåŒJsçš„äº¤äº’æ–¹æ¡ˆ</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-07-28_Android_WebView_Comication_With_Js">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-07-28</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/IW3pC-_2y" class="tag">WebView</a>


	<a href="https://kutear.github.io/tag/2bhUImQpoP" class="tag">Android</a>



</span>

<span>5 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-07-26_Android_Hot_Fix" >Android çƒ­ä¿®å¤</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-07-26_Android_Hot_Fix">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-07-26</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	

</span>

<span>1 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-07-24-c_list_study" >å•é“¾è¡¨å­¦ä¹ </a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-07-24-c_list_study">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-07-24</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/5meBnw6SC" class="tag">æ•°æ®ç»“æ„</a>


	<a href="https://kutear.github.io/tag/EGAW1QPhVh" class="tag">ç®—æ³•</a>



</span>

<span>4 min read</span>


    </div>

  </div>

</div>
	

	
<div class="post">
  <div class="post_title weaklink">
    <h2><a href="https://kutear.github.io/post/2016-07-18-Android_Studio" >Android Studioä½¿ç”¨æŒ‡å—(Windows/Linux)</a>
    </h2>
  </div>
  <div class="post_content markdown"><div class="p_part"><p></p></div></div>
  <a class="pure-button" href="https://kutear.github.io/post/2016-07-18-Android_Studio">Read More >>> </a>
  <div class="post_footer">
    <div class="info weaklink"><i class="fa fa-clock-o"></i>
<span class="date_info">2016-07-18</span>

<i class="fa fa-bookmark-o"></i>
	
<span class="tags_info weaklink">
	
	<a href="https://kutear.github.io/tag/UFhnp1WSL" class="tag">å·¥å…·ä½¿ç”¨</a>


	<a href="https://kutear.github.io/tag/JMHt1LA5wo" class="tag">Android Studio</a>



</span>

<span>6 min read</span>


    </div>

  </div>

</div>
	
	

<div class="paginator pager pagination" >
	
  <div class="paginator_container pagination_container">
	  
	    								
										
	  
	  <a href="https://kutear.github.io/page/2/"  class="btn next older-posts older_posts"> Older Posts </a>



    <div style="clear:both;height:0;"></div>


  </div>

</div>
</div>
  </div>
</div>

    </div>
   <div class="footer">
<div class="site_footer_wrap"><div class="site_footer">

      <div class="mysocials"><div class="my_socials">
		   
			   
    
			   
    
			   
    
			   
    
			   
    
			   
    
</div>
      </div>

      <div class="copyright" id="copyright">
	  <script>
		var date=new Date;
		var year=date.getFullYear(); 
		document.write("Copyright Â© "+year+" " + "KuTeat. ");
		</script>
		Powered by Gridea.
		<br>
		æœ¬ç«™å·²ç¨³å®šè¿è¡Œäº†
		<strong><script type="text/javascript">
		var urodz= new Date("10/28/2018");
		var now = new Date();
		var ile = now.getTime() - urodz.getTime();
		var dni = Math.floor(ile / (1000 * 60 * 60 * 24));
		document.write(+dni)
		</script>
		</strong>å¤©
		<br>
		æœ¬ç«™æ€»è®¿é—®é‡ä¸º <strong><span id="busuanzi_value_site_uv"></span></strong> æ¬¡
	  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
      </div>
	  <img src="https://kutear.github.io/media/images/font.svg">

    </div>

<script type="text/javascript" src="https://kutear.github.io/media/scripts/love.js"></script>
<script type="text/javascript" src="https://kutear.github.io/media/scripts/darkmode.js"></script>
<script>
var options = {
  bottom: '64px', // default: '32px'
  right: '32px', // default: '32px'
  left: 'unset', // default: 'unset'
  time: '0.5s', // default: '0.3s'
  mixColor: '#fff', // default: '#fff'
  backgroundColor: '#fff',  // default: '#fff'
  buttonColorDark: '#100f2c',  // default: '#100f2c'
  buttonColorLight: '#fff', // default: '#fff'
  saveInCookies: false, // default: true,
  label: 'ğŸŒ“', // default: ''
  autoMatchOsTheme: true // default: true
}

const darkmode = new Darkmode(options);
darkmode.showWidget();
</script>
<script>
hljs.initHighlightingOnLoad();
</script>

</body>

</html>
